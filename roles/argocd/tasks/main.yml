---
- name: Create argocd namespace
  become_user: ansible
  command: kubectl create namespace argocd
  register: ns_result
  failed_when: ns_result.rc != 0 and 'already exists' not in ns_result.stderr
  changed_when: ns_result.rc == 0

- name: Install ArgoCD
  become_user: ansible
  command: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  register: argocd_result
  changed_when: "'created' in argocd_result.stdout or 'configured' in argocd_result.stdout"

- name: Wait for ArgoCD pods
  become_user: ansible
  command: kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s
  retries: 5
  delay: 30
  register: argocd_wait
  until: argocd_wait.rc == 0

- name: Expose ArgoCD as LoadBalancer
  become_user: ansible
  command: kubectl patch svc argocd-server -n argocd -p '{"spec":{"type":"LoadBalancer"}}'
  register: patch_result
  changed_when: "'patched' in patch_result.stdout"

- name: Get ArgoCD admin password
  become_user: ansible
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password
  changed_when: false

- name: Display ArgoCD info
  debug:
    msg: |
      ArgoCD installed successfully!
      Admin Password: {{ argocd_password.stdout }}
