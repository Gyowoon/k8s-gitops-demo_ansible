---
- name: Install MetalLB
  become_user: ansible
  command: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v{{ metallb_version }}/config/manifests/metallb-native.yaml
  register: metallb_result
  changed_when: "'created' in metallb_result.stdout or 'configured' in metallb_result.stdout"

- name: Wait for MetalLB controller
  become_user: ansible
  command: kubectl wait --for=condition=Ready pods -l app=metallb,component=controller -n metallb-system --timeout=180s
  retries: 3
  delay: 20
  register: metallb_wait
  until: metallb_wait.rc == 0

- name: Create MetalLB IPAddressPool configuration
  become_user: ansible
  shell: |
    kubectl apply -f - << 'YAML'
    apiVersion: metallb.io/v1beta1
    kind: IPAddressPool
    metadata:
      name: default-pool
      namespace: metallb-system
    spec:
      addresses:
      - {{ metallb_ip_range }}
    ---
    apiVersion: metallb.io/v1beta1
    kind: L2Advertisement
    metadata:
      name: default
      namespace: metallb-system
    spec:
      ipAddressPools:
      - default-pool
    YAML
  register: pool_result
  changed_when: "'created' in pool_result.stdout or 'configured' in pool_result.stdout"
